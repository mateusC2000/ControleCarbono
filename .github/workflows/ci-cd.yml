# .github/workflows/ci-cd.yml

# Nome do Workflow que aparecerÃ¡ na aba "Actions" do GitHub
name: CI/CD Pipeline - ControleCarbono

# Gatilhos (Triggers): Define quando o workflow deve ser executado
on:
  # Executa em todo push para a branch 'main'
  push:
    branches:
      - main
  # Permite que o workflow seja executado manualmente a partir da interface do GitHub
  workflow_dispatch:

# PermissÃµes para o token do GitHub usado no workflow
permissions:
  contents: read
  id-token: write

jobs:
  # 1. Job de Build e Teste
  build-and-test:
    name: Build e Testes
    runs-on: ubuntu-latest # Executa em uma mÃ¡quina virtual Linux (Ubuntu)

    steps:
      # Passo 1: Clona o repositÃ³rio para a mÃ¡quina virtual
      - name: â¬‡ï¸ Checkout do cÃ³digo
        uses: actions/checkout@v4

      # Passo 2: Configura o ambiente Node.js (ajuste a versÃ£o conforme seu projeto)
      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # Habilita o cache para as dependÃªncias do npm

      # Passo 3: Instala as dependÃªncias do projeto
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci # 'ci' Ã© mais rÃ¡pido e seguro para automaÃ§Ã£o do que 'install'

      # Passo 4: Executa os testes automatizados (requisito da atividade)
      - name: ğŸ§ª Executar testes
        run: npm test

      # Passo 5: Gera a build da aplicaÃ§Ã£o (requisito da atividade)
      - name: ğŸ—ï¸ Gerar build da aplicaÃ§Ã£o
        run: npm run build

      # Passo 6: Salva o artefato da build para ser usado nos jobs de deploy
      - name: â¬†ï¸ Upload do artefato da build
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact # Nome do artefato
          path: dist/ # Caminho da pasta de build (ajuste se for 'build' ou outro)

  # 2. Job de Deploy para Staging (HomologaÃ§Ã£o)
  deploy-staging:
    name: Deploy para Staging
    needs: build-and-test # Depende do sucesso do job 'build-and-test'
    runs-on: ubuntu-latest
    environment:
      name: staging # Define o ambiente do GitHub

    steps:
      # Passo 1: Baixa o artefato da build gerado no job anterior
      - name: â¬‡ï¸ Download do artefato da build
        uses: actions/download-artifact@v4
        with:
          name: build-artifact

      # Passo 2: Simula o deploy para o ambiente de staging
      # SUBSTITUA ESTE PASSO PELOS SEUS COMANDOS REAIS DE DEPLOY
      - name: ğŸš€ Deploy para Staging
        run: |
          echo "ğŸš€ Fazendo deploy da build para o ambiente de Staging..."
          # Exemplo: Copiar arquivos para um servidor via SSH/SCP
          # scp -r . user@staging-server:/var/www/html
          echo "âœ… Deploy em Staging concluÃ­do."

  # 3. Job de Deploy para ProduÃ§Ã£o (com aprovaÃ§Ã£o manual)
  deploy-production:
    name: Deploy para ProduÃ§Ã£o
    needs: deploy-staging # Depende do sucesso do deploy em staging
    runs-on: ubuntu-latest
    environment:
      name: production # Define o ambiente de produÃ§Ã£o

    steps:
      # Passo 1: Baixa o artefato da build
      - name: â¬‡ï¸ Download do artefato da build
        uses: actions/download-artifact@v4
        with:
          name: build-artifact

      # Passo 2: Simula o deploy para o ambiente de produÃ§Ã£o
      # SUBSTITUA ESTE PASSO PELOS SEUS COMANDOS REAIS DE DEPLOY
      - name: ğŸš€ Deploy para ProduÃ§Ã£o
        run: |
          echo "ğŸš€ Fazendo deploy da build para o ambiente de ProduÃ§Ã£o..."
          # Exemplo: Usar o CLI da AWS para sincronizar com um bucket S3
          # aws s3 sync . s3://meu-bucket-de-producao
          echo "âœ… Deploy em ProduÃ§Ã£o concluÃ­do."
